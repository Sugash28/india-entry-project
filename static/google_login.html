<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Login Test</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <style>
        .btn {
            display: inline-block;
            padding: 10px 20px;
            margin: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
        }

        .btn-google {
            background: white;
            color: #444;
        }

        .btn-ms {
            background: #2F2F2F;
            color: white;
            border: none;
        }
    </style>
</head>

<body
    style="font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: #f0f2f5;">

    <div
        style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; max-width: 500px;">
        <h2>Authentication Test</h2>
        <p>Test Google and Microsoft Login flows.</p>
        <p style="font-size: 0.9em; color: #555; background: #eee; padding: 5px; border-radius: 4px;">
            Current Origin: <strong id="origin-display">Loading...</strong><br>
            <span style="font-size: 0.8em; color: #d32f2f;">(Must be registered in Cloud Consoles)</span>
        </p>

        <div style="margin-bottom: 1rem;">
            <label>
                <input type="radio" name="user_type" value="client" checked> Client
            </label>
            <label style="margin-left: 1rem;">
                <input type="radio" name="user_type" value="service_provider"> Service Provider
            </label>
        </div>

        <!-- Google -->
        <div id="g_id_onload" data-client_id="539440677347-7dadrilnks0kn51a9q1f8c3v7str0h93.apps.googleusercontent.com"
            data-callback="handleCredentialResponse" data-auto_prompt="false">
        </div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with"
            data-shape="rectangular" data-logo_alignment="left">
        </div>

        <div style="margin: 15px 0; border-top: 1px solid #eee;"></div>

        <!-- Microsoft -->
        <button class="btn btn-ms" onclick="signInMicrosoft()">Sign in with Microsoft</button>

        <div id="result" style="margin-top: 20px; text-align: left; max-width: 100%; overflow-wrap: break-word;"></div>
    </div>

    <script>
        document.getElementById('origin-display').innerText = window.location.origin;

        // --- Google ---
        async function handleCredentialResponse(response) {
            sendTokenToBackend(response.credential, 'google');
        }

        // --- Microsoft ---
        const msalConfig = {
            auth: {
                clientId: "365ff30a-6fd2-4ad1-9d34-91845ccb618e",
                authority: "https://login.microsoftonline.com/aea9dfde-d6c4-4b08-be03-a56388eddc74",
                redirectUri: window.location.origin + "/static/google_login.html",
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false,
            }
        };

        const myMSALObj = new msal.PublicClientApplication(msalConfig);

        async function signInMicrosoft() {
            try {
                await myMSALObj.initialize();
                const loginResponse = await myMSALObj.loginPopup({
                    scopes: ["User.Read", "email", "openid", "profile"]
                });
                console.log("MS Login Response:", loginResponse);
                sendTokenToBackend(loginResponse.idToken, 'microsoft');
            } catch (error) {
                console.error("Microsoft Login Error:", error);
                document.getElementById('result').innerHTML = `<p style="color: red;">MS Error: ${error.message}</p>`;
            }
        }

        // --- Backend Function ---
        async function sendTokenToBackend(token, provider) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = "Processing " + provider + " token...";

            const userType = document.querySelector('input[name="user_type"]:checked').value;
            const endpoint = `/api/v1/auth/login/${provider}/${userType}`;

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });

                const data = await res.json();

                if (res.ok) {
                    resultDiv.innerHTML = `<p style="color: green;"><strong>${provider} Login Successful!</strong></p>
                                           <p><strong>Access Token:</strong> ${data.access_token.substring(0, 20)}...</p>`;
                    console.log("Backend Response:", data);
                } else {
                    resultDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${data.detail}</p>`;
                }
            } catch (error) {
                resultDiv.innerText = "Network Error: " + error.message;
            }
        }
    </script>
</body>

</html>